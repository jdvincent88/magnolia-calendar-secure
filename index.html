<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Magnolia Room • Events Calendar</title>

  <!-- Playfair Display -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- FullCalendar CSS (core has no CSS in v6) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.15/index.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.15/index.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fullcalendar/list@6.1.15/index.css">

  <style>
    /* ===== THEME ===== */
    :root{
      --mk-page-bg:   #fff8f3;
      --mk-frame:     #6C0101;   /* deep maroon */
      --mk-header-bg: #6C0101;
      --mk-header-tx: #ffffff;
      --mk-accent:    #DE8F05;   /* old gold */
      --mk-accent-2:  #9A6A35;   /* antique gold */
      --mk-text:      #2b2b2b;
      --mk-font:      "Playfair Display", Georgia, "Times New Roman", serif;
      --mk-radius:    16px;
    }

    /* Page + frame */
    html, body { margin:0; padding:0; background:var(--mk-page-bg); color:var(--mk-text); font-family:var(--mk-font); }
    .wrap { max-width:1100px; margin:28px auto; padding:0 14px; }
    .frame { background:#fff; border:2px solid var(--mk-frame); border-radius:var(--mk-radius); box-shadow:0 8px 24px rgba(0,0,0,.12); overflow:hidden; }
    .hdr { display:flex; align-items:center; justify-content:space-between; background:var(--mk-header-bg); color:var(--mk-header-tx); padding:12px 16px; border-bottom:2px solid var(--mk-frame); letter-spacing:.2px; font-weight:700; }
    .hdr-title { font-size: clamp(18px, 2.1vw, 22px); }
    #calendar { padding:10px; }

    /* FullCalendar theme */
    .fc{
      --fc-page-bg-color:#fff;
      --fc-neutral-bg-color: color-mix(in oklab, var(--mk-header-bg) 8%, white);
      --fc-border-color: var(--mk-frame);
      --fc-text-color:#222;
      --fc-today-bg-color: color-mix(in oklab, var(--mk-accent) 18%, white);
      --fc-event-bg-color: var(--mk-accent);
      --fc-event-border-color: var(--mk-accent);
      --fc-event-text-color:#fff;
      --fc-now-indicator-color: var(--mk-accent);

      --fc-button-text-color:#fff;
      --fc-button-bg-color: color-mix(in oklab, var(--mk-header-bg) 90%, black);
      --fc-button-border-color: var(--mk-frame);
      --fc-button-hover-bg-color: color-mix(in oklab, var(--mk-header-bg) 80%, black);
      --fc-button-active-bg-color: var(--mk-accent);
      font-family: var(--mk-font);
    }
    .fc .fc-toolbar.fc-header-toolbar{ background:var(--mk-header-bg); color:var(--mk-header-tx); border:1px solid var(--mk-frame); border-radius:12px; padding:8px 10px; margin-bottom:10px; }
    .fc .fc-button{ border-radius:10px; }
    .fc .fc-daygrid-event{ border-radius:8px; padding:2px 4px; }

    /* Hover tooltip */
    .mk-tip{ position:fixed; z-index:9999; background:#fff; color:#000; border:1px solid var(--mk-frame); border-radius:10px; padding:8px 10px; box-shadow:0 10px 30px rgba(0,0,0,.2); max-width:260px; font-size:13px; }
    .mk-tip h4{ margin:0 0 4px; font-size:14px; color:#000; }
    .mk-tip small{ color:#333; }

    /* Event details modal */
    #viewModal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:99999; align-items:center; justify-content:center; }
    #viewCard{ background:#fff; max-width:720px; width:94%; border:2px solid var(--mk-frame); border-radius:16px; box-shadow:0 12px 36px rgba(0,0,0,.25); overflow:hidden; }
    #viewHead{ background:var(--mk-header-bg); color:#fff; padding:10px 14px; font-weight:700; display:flex; align-items:center; justify-content:space-between; }
    #viewBody{ padding:14px; }
    #viewBody img{ max-width:100%; border-radius:12px; border:1px solid #ddd; }
    .kv{ margin:6px 0; }
    .kv b{ display:inline-block; min-width:90px; color:#000; }
    .closeBtn{ background:#fff; color:#000; border:1px solid var(--mk-frame); border-radius:10px; padding:6px 10px; font-weight:600; }
    .btnRow{ display:flex; gap:8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="frame">
      <div class="hdr"><div class="hdr-title">The Magnolia Room • Events Calendar</div></div>

      <!-- ▼▼▼ ADDED: simple search UI ▼▼▼ -->
      <div id="filters" style="padding:10px 12px">
        <input id="q" placeholder="Search (title or details)" style="padding:8px;border:1px solid #cfc;border-radius:10px;width:60%" />
        <button id="clearQ" class="closeBtn" style="margin-left:6px">Clear</button>
      </div>
      <!-- ▲▲▲ ADDED: simple search UI ▲▲▲ -->

      <div id="calendar"></div>
    </div>
  </div>

  <!-- FullCalendar JS bundle (REQUIRED) -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <!-- Calendar + modal logic -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const el = document.getElementById('calendar');

      // --- Simple text search DOM handles & state ---
      const q = document.getElementById('q');
      const clearQ = document.getElementById('clearQ');
      let currentNeedle = '';

      // ---- Hover tooltip helpers ----
      let tipEl = null;
      const showTip = (info) => {
        const rect = info.el.getBoundingClientRect();
        const when = formatRange(info.event);
        const html = `
          <h4>${escapeHtml(info.event.title || '')}</h4>
          <small>${when}</small>
          ${info.event.extendedProps.location ? `<div class="kv"><b>Where:</b> ${escapeHtml(info.event.extendedProps.location)}</div>` : ''}
        `;
        tipEl = document.createElement('div');
        tipEl.className = 'mk-tip';
        tipEl.innerHTML = html;
        document.body.appendChild(tipEl);
        const top = Math.max(8, rect.top - tipEl.offsetHeight - 8);
        const left = Math.min(window.innerWidth - tipEl.offsetWidth - 8, Math.max(8, rect.left));
        tipEl.style.top = top + 'px';
        tipEl.style.left = left + 'px';
      };
      const hideTip = () => { if (tipEl) { tipEl.remove(); tipEl = null; } };

      // ---- FullCalendar init ----
      const calendar = new FullCalendar.Calendar(el, {
        initialView: 'dayGridMonth',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek' },
        height: 'auto',

        // Read events from your Netlify Function
        events: function (info, success, failure) {
          const url = '/.netlify/functions/get-events'
            + '?timeMin=' + encodeURIComponent(info.startStr)
            + '&timeMax=' + encodeURIComponent(info.endStr);
          fetch(url)
            .then(r => r.ok ? r.json() : r.text().then(t => Promise.reject(t)))
            .then(data => success(data.events || []))
            .catch(err => failure(err));
        },

        eventMouseEnter: showTip,
        eventMouseLeave: hideTip,
        eventClick: function (info) {
          info.jsEvent.preventDefault();
          hideTip();
          openEventModal(info.event); // <--- opens modal
        },
        eventDidMount: (info) => { if (info.event?.title) info.el.title = info.event.title; }
      });

      // ------- FILTERING (simple, no database) -------
      function applyFilter(){
        const needle = currentNeedle;
        calendar.batchRendering(() => {
          calendar.getEvents().forEach(evt => {
            const hay = ((evt.title || '') + ' ' + ((evt.extendedProps && evt.extendedProps.description) || '')).toLowerCase();
            const visible = !needle || hay.includes(needle);
            evt.setProp('display', visible ? 'auto' : 'none');
          });
        });
      }
      calendar.on('eventsSet', () => applyFilter());
      if (q) q.addEventListener('input', (e)=>{ currentNeedle = (e.target.value || '').trim().toLowerCase(); applyFilter(); });
      if (clearQ) clearQ.addEventListener('click', ()=>{ if (q) q.value=''; currentNeedle=''; applyFilter(); });
      // ----------------------------------------------

      calendar.render();

      // ---- Mobile default view (list on phones) ----
      const setViewForWidth = () => {
        const desired = (window.innerWidth < 640 ? 'listWeek' : 'dayGridMonth');
        if (calendar.view.type !== desired) calendar.changeView(desired);
      };
      setViewForWidth();
      window.addEventListener('resize', setViewForWidth);

      // ---- Keep iframe height correct when embedded ----
      function postHeight() { parent.postMessage({ type: 'mkCalendarHeight', height: document.body.scrollHeight }, '*'); }
      new ResizeObserver(postHeight).observe(document.body);
      window.addEventListener('load', postHeight);
      setTimeout(postHeight, 500);

      // ---- Helpers used above ----
      function formatRange(event) {
        const s = event.start, e = event.end || event.start;
        const dOpts = { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' };
        const tOpts = { hour: 'numeric', minute: '2-digit' };
        if (event.allDay) {
          return s.toLocaleDateString(undefined, dOpts)
            + (e && e > s ? ' – ' + new Date(e.getTime() - 1).toLocaleDateString(undefined, dOpts) : '');
        }
        const sStr = s.toLocaleDateString(undefined, dOpts) + ' ' + s.toLocaleTimeString(undefined, tOpts);
        const eStr = e.toLocaleTimeString(undefined, tOpts);
        return sStr + ' – ' + eStr;
      }
      function escapeHtml(x) { return (x || '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m])); }
    });

    // ===== Event Details Modal (global) =====
    function openEventModal(event) {
      const modal = document.getElementById('viewModal');
      const title = document.getElementById('viewTitle');
      const body  = document.getElementById('viewBody');

      title.textContent = event.title || 'Event';

      // Pretty "When" string
      const when = (function(){
        const allDay = event.allDay;
        const s = event.start, e = event.end || event.start;
        const dOpts = { weekday:'long', month:'long', day:'numeric', year:'numeric' };
        const tOpts = { hour:'numeric', minute:'2-digit' };
        if (allDay) {
          return s.toLocaleDateString(undefined, dOpts)
            + (e && e > s ? ' – ' + new Date(e.getTime()-1).toLocaleDateString(undefined, dOpts) : '');
        }
        const sStr = s.toLocaleDateString(undefined, dOpts) + ' ' + s.toLocaleTimeString(undefined, tOpts);
        const eStr = (e || s).toLocaleTimeString(undefined, tOpts);
        return sStr + ' – ' + eStr;
      })();

      // Build details HTML
      const loc  = event.extendedProps.location ? `<div class="kv"><b>Where:</b> ${escapeHtml(event.extendedProps.location)}</div>` : '';
      const desc = event.extendedProps.description ? `<div class="kv"><b>Details:</b> ${linkify(event.extendedProps.description)}</div>` : '';
      const flyer = (function(){
        const f = event.extendedProps.flyer;
        if (!f) return '';
        if (/\.(png|jpe?g|webp|gif)$/i.test(f)) return `<div class="kv"><img alt="Flyer" src="${f}"></div>`;
        return `<div class="kv"><a href="${f}" target="_blank" rel="noopener">View flyer</a></div>`;
      })();
      const gcal = event.url ? `<div class="kv"><a href="${event.url}" target="_blank" rel="noopener">Open in Google Calendar</a></div>` : '';

      body.innerHTML = `<div class="kv"><b>When:</b> ${when}</div>${loc}${desc}${flyer}${gcal}`;

      // Wire up buttons
      const closeBtn = document.getElementById('viewClose');
      const icsBtn   = document.getElementById('viewIcs');

      modal.style.display = 'flex';
      document.body.classList.add('modal-open');

      closeBtn.onclick = () => { modal.style.display = 'none'; document.body.classList.remove('modal-open'); };
      modal.onclick = (e) => { if (e.target === modal) { modal.style.display = 'none'; document.body.classList.remove('modal-open'); } };

      if (icsBtn) icsBtn.onclick = () => saveIcsForEvent(event);
    }

    // Turn plain URLs in text into clickable links
    function linkify(t){
      const esc = (x)=> (x||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
      return esc(t).split(/\s/).map(w => /^https?:\/\/[^\s<>"']+$/i.test(w)
        ? `<a href="${w}" target="_blank" rel="noopener">${w}</a>` : w).join(' ');
    }

    // ===== .ICS (Add to Calendar) helper =====
    function saveIcsForEvent(evt){
      const pad = (n)=> String(n).padStart(2,'0');
      const fmtUTC = (d)=> {
        const z = new Date(d.getTime() - d.getTimezoneOffset()*60000); // normalize to UTC
        return z.getUTCFullYear()
          + pad(z.getUTCMonth()+1) + pad(z.getUTCDate()) + 'T'
          + pad(z.getUTCHours()) + pad(z.getUTCMinutes()) + pad(z.getUTCSeconds()) + 'Z';
      };

      let dtStart, dtEnd, alldayBlock = '';
      if (evt.allDay) {
        dtStart = evt.start.toISOString().slice(0,10).replace(/-/g,'');
        const endDate = (evt.end || evt.start).toISOString().slice(0,10).replace(/-/g,'');
        dtEnd   = endDate;
        alldayBlock = ';VALUE=DATE';
      } else {
        dtStart = fmtUTC(evt.start);
        dtEnd   = fmtUTC(evt.end || evt.start);
      }

      const uid = (evt.id || (Date.now()+'@magnolia'));
      const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//The Magnolia Room//Calendar//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
UID:${uid}
SUMMARY:${(evt.title||'').replace(/\n/g,' ')}
DTSTART${alldayBlock}:${dtStart}
DTEND${alldayBlock}:${dtEnd}
LOCATION:${(evt.extendedProps?.location||'').replace(/\n/g,' ')}
DESCRIPTION:${(evt.extendedProps?.description||'').replace(/\n/g,' ')}
END:VEVENT
END:VCALENDAR`;

      const blob = new Blob([ics], { type: 'text/calendar' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (evt.title || 'event') + '.ics';
      document.body.appendChild(a); a.click(); a.remove();
    }
  </script>

  <!-- Event Details Modal -->
  <div id="viewModal" role="dialog" aria-modal="true" aria-labelledby="viewTitle">
    <div id="viewCard">
      <div id="viewHead">
        <div id="viewTitle">Event</div>
        <div class="btnRow">
          <button id="viewIcs" class="closeBtn">Add to Calendar</button>
          <button id="viewClose" class="closeBtn">Close</button>
        </div>
      </div>
      <div id="viewBody"></div>
    </div>
  </div>
</body>
</html>

