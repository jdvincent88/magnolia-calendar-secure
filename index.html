<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Magnolia Room • Events Calendar</title>

  <!-- Playfair Display -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- FullCalendar CSS (core has no CSS in v6) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.15/index.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.15/index.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fullcalendar/list@6.1.15/index.css">

  <style>
    /* ===== THEME ===== */
    :root{
      --mk-page-bg:   #fff8f3;
      --mk-frame:     #6C0101;   /* deep maroon */
      --mk-header-bg: #6C0101;
      --mk-header-tx: #ffffff;
      --mk-accent:    #DE8F05;   /* old gold */
      --mk-accent-2:  #9A6A35;   /* antique gold */
      --mk-text:      #2b2b2b;
      --mk-font:      "Playfair Display", Georgia, "Times New Roman", serif;
      --mk-radius:    16px;
    }

    /* Page + frame */
    html, body { margin:0; padding:0; background:var(--mk-page-bg); color:var(--mk-text); font-family:var(--mk-font); }
    .wrap { max-width:1100px; margin:28px auto; padding:0 14px; }
    .frame { background:#fff; border:2px solid var(--mk-frame); border-radius:var(--mk-radius); box-shadow:0 8px 24px rgba(0,0,0,.12); overflow:hidden; }
    .hdr { display:flex; align-items:center; justify-content:space-between; background:var(--mk-header-bg); color:var(--mk-header-tx); padding:12px 16px; border-bottom:2px solid var(--mk-frame); letter-spacing:.2px; font-weight:700; }
    .hdr-title { font-size: clamp(18px, 2.1vw, 22px); }
    #calendar { padding:10px; }

    /* FullCalendar theme */
    .fc{
      --fc-page-bg-color:#fff;
      --fc-neutral-bg-color: color-mix(in oklab, var(--mk-header-bg) 8%, white);
      --fc-border-color: var(--mk-frame);
      --fc-text-color:#222;
      --fc-today-bg-color: color-mix(in oklab, var(--mk-accent) 18%, white);
      --fc-event-bg-color: var(--mk-accent);
      --fc-event-border-color: var(--mk-accent);
      --fc-event-text-color:#fff;
      --fc-now-indicator-color: var(--mk-accent);

      --fc-button-text-color:#fff;
      --fc-button-bg-color: color-mix(in oklab, var(--mk-header-bg) 90%, black);
      --fc-button-border-color: var(--mk-frame);
      --fc-button-hover-bg-color: color-mix(in oklab, var(--mk-header-bg) 80%, black);
      --fc-button-active-bg-color: var(--mk-accent);
      font-family: var(--mk-font);
    }
    .fc .fc-toolbar.fc-header-toolbar{ background:var(--mk-header-bg); color:var(--mk-header-tx); border:1px solid var(--mk-frame); border-radius:12px; padding:8px 10px; margin-bottom:10px; }
    .fc .fc-button{ border-radius:10px; }
    .fc .fc-daygrid-event{ border-radius:8px; padding:2px 4px; }

    /* Hover tooltip */
    .mk-tip{ position:fixed; z-index:9999; background:#fff; color:#000; border:1px solid var(--mk-frame); border-radius:10px; padding:8px 10px; box-shadow:0 10px 30px rgba(0,0,0,.2); max-width:260px; font-size:13px; }
    .mk-tip h4{ margin:0 0 4px; font-size:14px; color:#000; }
    .mk-tip small{ color:#333; }

    /* Event details modal */
    #viewModal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:99999; align-items:center; justify-content:center; }
    #viewCard{ background:#fff; max-width:720px; width:94%; border:2px solid var(--mk-frame); border-radius:16px; box-shadow:0 12px 36px rgba(0,0,0,.25); overflow:hidden; }
    #viewHead{ background:var(--mk-header-bg); color:#fff; padding:10px 14px; font-weight:700; display:flex; align-items:center; justify-content:space-between; }
    #viewBody{ padding:14px; }
    #viewBody img{ max-width:100%; border-radius:12px; border:1px solid #ddd; }
    .kv{ margin:6px 0; }
    .kv b{ display:inline-block; min-width:90px; color:#000; }
    .closeBtn{ background:#fff; color:#000; border:1px solid var(--mk-frame); border-radius:10px; padding:6px 10px; font-weight:600; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="frame">
      <div class="hdr"><div class="hdr-title">The Magnolia Room • Events Calendar</div></div>
      <div id="calendar"></div>
    </div>
  </div>

  <!-- FullCalendar (globals build) -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      const el = document.getElementById('calendar');

      // Simple hover tooltip
      let tipEl = null;
      const showTip = (info) => {
        const rect = info.el.getBoundingClientRect();
        const when = formatRange(info.event);
        const html = `
          <h4>${escapeHtml(info.event.title || '')}</h4>
          <small>${when}</small>
          ${info.event.extendedProps.location ? `<div class="kv"><b>Where:</b> ${escapeHtml(info.event.extendedProps.location)}</div>` : ''}
        `;
        tipEl = document.createElement('div');
        tipEl.className = 'mk-tip';
        tipEl.innerHTML = html;
        document.body.appendChild(tipEl);
        const top = Math.max(8, rect.top - tipEl.offsetHeight - 8);
        const left = Math.min(window.innerWidth - tipEl.offsetWidth - 8, Math.max(8, rect.left));
        tipEl.style.top = top + 'px';
        tipEl.style.left = left + 'px';
      };
      const hideTip = () => { if (tipEl) { tipEl.remove(); tipEl = null; } };

      const calendar = new FullCalendar.Calendar(el, {
        initialView: 'dayGridMonth',
        headerToolbar: { left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,timeGridDay,listWeek' },
        height: 'auto',

        // Read events from your Netlify Function
        events: function(info, success, failure){
          const url = '/.netlify/functions/get-events'
            + '?timeMin=' + encodeURIComponent(info.startStr)
            + '&timeMax=' + encodeURIComponent(info.endStr);
          fetch(url)
            .then(r => r.ok ? r.json() : r.text().then(t => Promise.reject(t)))
            .then(data => success(data.events || []))
            .catch(err => failure(err));
        },

        eventMouseEnter: showTip,
        eventMouseLeave: hideTip,
        eventClick: function(info){
          info.jsEvent.preventDefault();
          hideTip();
          openEventModal(info.event);
        },
        eventDidMount: (info) => { if (info.event?.title) info.el.title = info.event.title; }
      });

      calendar.render();

      /* ===== MOBILE DEFAULT VIEW SNIPPET =====
         Phones show listWeek; larger screens show month.
      */
      const setViewForWidth = () => {
        const desired = (window.innerWidth < 640 ? 'listWeek' : 'dayGridMonth');
        if (calendar.view.type !== desired) calendar.changeView(desired);
      };
      setViewForWidth();
      window.addEventListener('resize', setViewForWidth);

      // Keep iframe height correct when embedded
      function postHeight(){ parent.postMessage({ type:'mkCalendarHeight', height:document.body.scrollHeight }, '*'); }
      new ResizeObserver(postHeight).observe(document.body);
      window.addEventListener('load', postHeight);
      setTimeout(postHeight, 500);

      // helpers
      function formatRange(event){
        const s = event.start, e = event.end || event.start;
        const dOpts = { weekday:'short', month:'short', day:'numeric', year:'numeric' };
        const tOpts = { hour:'numeric', minute:'2-digit' };
        if (event.allDay) {
          return s.toLocaleDateString(undefined, dOpts) + (e && e > s ? ' – ' + new Date(e.getTime()-1).toLocaleDateString(undefined, dOpts) : '');
        }
        const sStr = s.toLocaleDateString(undefined, dOpts) + ' ' + s.toLocaleTimeString(undefined, tOpts);
        const eStr = e.toLocaleTimeString(undefined, tOpts);
        return sStr + ' – ' + eStr;
      }
      function escapeHtml(x){ return (x||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
    });

    // Modal builder (outside handler so it’s global)
    function openEventModal(event){
      const modal = document.getElementById('viewModal');
      const title = document.getElementById('viewTitle');
      const body  = document.getElementById('viewBody');

      title.textContent = event.title || 'Event';
      const when = (function(){
        const allDay = event.allDay;
        const s = event.start, e = event.end || event.start;
        const dOpts = { weekday:'long', month:'long', day:'numeric', year:'numeric' };
        const tOpts = { hour:'numeric', minute:'2-digit' };
        if (allDay) {
          return s.toLocaleDateString(undefined, dOpts) + (e && e > s ? ' – ' + new Date(e.getTime()-1).toLocaleDateString(undefined, dOpts) : '');
        }
        const sStr = s.toLocaleDateString(undefined, dOpts) + ' ' + s.toLocaleTimeString(undefined, tOpts);
        const eStr = e.toLocaleTimeString(undefined, tOpts);
        return sStr + ' – ' + eStr;
      })();

      const loc = event.extendedProps.location ? `<div class="kv"><b>Where:</b> ${event.extendedProps.location}</div>` : '';
      const desc = event.extendedProps.description ? `<div class="kv"><b>Details:</b> ${linkify(event.extendedProps.description)}</div>` : '';
      const flyer = (function(){
        const f = event.extendedProps.flyer;
        if (!f) return '';
        if (/\.(png|jpe?g|webp|gif)$/i.test(f)) return `<div class="kv"><img alt="Flyer" src="${f}"></div>`;
        return `<div class="kv"><a href="${f}" target="_blank" rel="noopener">View flyer</a></div>`;
      })();
      const gcal = event.url ? `<div class="kv"><a href="${event.url}" target="_blank" rel="noopener">Open in Google Calendar</a></div>` : '';

      body.innerHTML = `<div class="kv"><b>When:</b> ${when}</div>${loc}${desc}${flyer}${gcal}`;

      modal.style.display = 'flex';
      document.body.classList.add('modal-open');

      document.getElementById('viewClose').onclick = () => { modal.style.display='none'; document.body.classList.remove('modal-open'); };
      modal.onclick = (e) => { if (e.target === modal) { modal.style.display='none'; document.body.classList.remove('modal-open'); } };
    }
    function linkify(t){
      const esc = (x)=>x.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
      const parts = esc(t||'').split(/\s/).map(w=>{
        if(/^https?:\/\/[^\s<>"']+$/i.test(w)){ return `<a href="${w}" target="_blank" rel="noopener">${w}</a>`; }
        return w;
      });
      return parts.join(' ');
    }
  </script>

  <!-- Event Details Modal -->
  <div id="viewModal">
    <div id="viewCard">
      <div id="viewHead">
        <div id="viewTitle">Event</div>
        <button id="viewClose" class="closeBtn">Close</button>
      </div>
      <div id="viewBody"></div>
    </div>
  </div>
</body>
</html>