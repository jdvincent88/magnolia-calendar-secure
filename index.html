FullCalendar (globals build) -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      const el = document.getElementById('calendar');

      // Simple hover tooltip
      let tipEl = null;
      const showTip = (info) => {
        const rect = info.el.getBoundingClientRect();
        const when = formatRange(info.event);
        const html = `
          <h4>${escapeHtml(info.event.title || '')}</h4>
          <small>${when}</small>
          ${info.event.extendedProps.location ? `<div class="kv"><b>Where:</b> ${escapeHtml(info.event.extendedProps.location)}</div>` : ''}
        `;
        tipEl = document.createElement('div');
        tipEl.className = 'mk-tip';
        tipEl.innerHTML = html;
        document.body.appendChild(tipEl);
        const top = Math.max(8, rect.top - tipEl.offsetHeight - 8);
        const left = Math.min(window.innerWidth - tipEl.offsetWidth - 8, Math.max(8, rect.left));
        tipEl.style.top = top + 'px';
        tipEl.style.left = left + 'px';
      };
      const hideTip = () => { if (tipEl) { tipEl.remove(); tipEl = null; } };

      const calendar = new FullCalendar.Calendar(el, {
        initialView: 'dayGridMonth',
        headerToolbar: { left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,timeGridDay,listWeek' },
        height: 'auto',

        // Read events from your Netlify Function
        events: function(info, success, failure){
          const url = '/.netlify/functions/get-events'
            + '?timeMin=' + encodeURIComponent(info.startStr)
            + '&timeMax=' + encodeURIComponent(info.endStr);
          fetch(url)
            .then(r => r.ok ? r.json() : r.text().then(t => Promise.reject(t)))
            .then(data => success(data.events || []))
            .catch(err => failure(err));
        },

        eventMouseEnter: showTip,
        eventMouseLeave: hideTip,
        eventClick: function(info){
          info.jsEvent.preventDefault();
          hideTip();
          openEventModal(info.event);
        },
        eventDidMount: (info) => { if (info.event?.title) info.el.title = info.event.title; }
      });

      calendar.render();
      
      // Keep a quick index of events by id once they’re loaded
      let eventIndex = new Map();
      calendar.on('eventsSet', (events) => {
        eventIndex.clear();
        events.forEach(evt => eventIndex.set(evt.id, evt));
        // open by hash if present
        const m = location.hash.match(/^#e=([^&]+)/);
        if (m && eventIndex.has(decodeURIComponent(m[1]))) {
          openEventModal(eventIndex.get(decodeURIComponent(m[1])));
        }
      });
      
      // When an event is clicked, update the URL hash
      const originalClick = calendar.getOption('eventClick');
      calendar.setOption('eventClick', function(info){
        history.replaceState(null, '', '#e=' + encodeURIComponent(info.event.id));
        originalClick(info); // open popup as before
      });

      /* ===== MOBILE DEFAULT VIEW SNIPPET =====
         Phones show listWeek; larger screens show month.
      */
      const setViewForWidth = () => {
        const desired = (window.innerWidth < 640 ? 'listWeek' : 'dayGridMonth');
        if (calendar.view.type !== desired) calendar.changeView(desired);
      };
      setViewForWidth();
      window.addEventListener('resize', setViewForWidth);

      // Keep iframe height correct when embedded
      function postHeight(){ parent.postMessage({ type:'mkCalendarHeight', height:document.body.scrollHeight }, '*'); }
      new ResizeObserver(postHeight).observe(document.body);
      window.addEventListener('load', postHeight);
      setTimeout(postHeight, 500);

      // helpers
      function formatRange(event){
        const s = event.start, e = event.end || event.start;
        const dOpts = { weekday:'short', month:'short', day:'numeric', year:'numeric' };
        const tOpts = { hour:'numeric', minute:'2-digit' };
        if (event.allDay) {
          return s.toLocaleDateString(undefined, dOpts) + (e && e > s ? ' – ' + new Date(e.getTime()-1).toLocaleDateString(undefined, dOpts) : '');
        }
        const sStr = s.toLocaleDateString(undefined, dOpts) + ' ' + s.toLocaleTimeString(undefined, tOpts);
        const eStr = e.toLocaleTimeString(undefined, tOpts);
        return sStr + ' – ' + eStr;
      }
      function escapeHtml(x){ return (x||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
    });

    // Modal builder (outside handler so it’s global)
    function openEventModal(event){
      const modal = document.getElementById('viewModal');
      const title = document.getElementById('viewTitle');
      const body  = document.getElementById('viewBody');

      title.textContent = event.title || 'Event';
      const when = (function(){
        const allDay = event.allDay;
        const s = event.start, e = event.end || event.start;
        const dOpts = { weekday:'long', month:'long', day:'numeric', year:'numeric' };
        const tOpts = { hour:'numeric', minute:'2-digit' };
        if (allDay) {
          return s.toLocaleDateString(undefined, dOpts) + (e && e > s ? ' – ' + new Date(e.getTime()-1).toLocaleDateString(undefined, dOpts) : '');
        }
        const sStr = s.toLocaleDateString(undefined, dOpts) + ' ' + s.toLocaleTimeString(undefined, tOpts);
        const eStr = e.toLocaleTimeString(undefined, tOpts);
        return sStr + ' – ' + eStr;
      })();

      const loc = event.extendedProps.location ? `<div class="kv"><b>Where:</b> ${event.extendedProps.location}</div>` : '';
      const desc = event.extendedProps.description ? `<div class="kv"><b>Details:</b> ${linkify(event.extendedProps.description)}</div>` : '';
      const flyer = (function(){
        const f = event.extendedProps.flyer;
        if (!f) return '';
        if (/\.(png|jpe?g|webp|gif)$/i.test(f)) return `<div class="kv"><img alt="Flyer" src="${f}"></div>`;
        return `<div class="kv"><a href="${f}" target="_blank" rel="noopener">View flyer</a></div>`;
      })();
      const gcal = event.url ? `<div class="kv"><a href="${event.url}" target="_blank" rel="noopener">Open in Google Calendar</a></div>` : '';

      body.innerHTML = `<div class="kv"><b>When:</b> ${when}</div>${loc}${desc}${flyer}${gcal}`;

      modal.style.display = 'flex';
      document.body.classList.add('modal-open');

      document.getElementById('viewClose').onclick = () => { modal.style.display='none'; document.body.classList.remove('modal-open'); };
      modal.onclick = (e) => { if (e.target === modal) { modal.style.display='none'; document.body.classList.remove('modal-open'); } };
    }
    function linkify(t){
      const esc = (x)=>x.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
      const parts = esc(t||'').split(/\s/).map(w=>{
        if(/^https?:\/\/[^\s<>"']+$/i.test(w)){ return `<a href="${w}" target="_blank" rel="noopener">${w}</a>`; }
        return w;
      });
      return parts.join(' ');
    }
  </script>